angular.module("FredrikSandell.worker-pool",[]).service("WorkerService",["$q",function(e){function t(e){var t="";return angular.forEach(e,function(e){c[e]&&(t+="importScripts('"+c[e].url+"');")}),t}function n(e){var t=[];return angular.forEach(e,function(e){c[e]&&t.push("'"+c[e].moduleName+"'")}),t.join(",")}function r(e){var r=e.filter(function(e){return"input"!==e&&"output"!==e&&"$q"!==e}),a={dependencies:r,moduleList:n(r),angularDepsAsStrings:r.length>0?","+r.map(function(e){return"'"+e+"'"}).join(","):"",angularDepsAsParamList:r.length>0?","+r.join(","):"",servicesIncludeStatements:t(r)};return a.workerFuncParamList="input,output"+a.angularDepsAsParamList,a}function a(e,t){return l.replace("<URL_TO_ANGULAR>",u).replace("<CUSTOM_DEP_INCLUDES>",t.servicesIncludeStatements).replace("<DEP_MODULES>",t.moduleList).replace("<STRING_DEP_NAMES>",t.angularDepsAsStrings).replace("<DEP_NAMES>",t.angularDepsAsParamList).replace("<WORKER_FUNCTION>",e.toString())}function o(e){return e.slice(0,e.length-1)}function i(e,t){return"("+e.toString()+")("+t+")"}var u,s={},c={},l=["","var window = self;","self.history = {};","self.Node = function () {};","var document = {","      readyState: 'complete',","      cookie: '',","      querySelector: function () {},","      createElement: function () {","          return {","              pathname: '',","              setAttribute: function () {}","          };","      }","};","importScripts('<URL_TO_ANGULAR>');","<CUSTOM_DEP_INCLUDES>","angular = window.angular;","var workerApp = angular.module('WorkerApp', [<DEP_MODULES>]);","workerApp.run(['$q'<STRING_DEP_NAMES>, function ($q<DEP_NAMES>) {","  self.addEventListener('message', function(e) {","    var input = e.data;","    var output = $q.defer();","    var promise = output.promise;","    promise.then(function(success) {","      self.postMessage({event:'success', data : success});","    }, function(reason) {","      self.postMessage({event:'failure', data : reason});","    }, function(update) {","      self.postMessage({event:'update', data : update});","    });","    <WORKER_FUNCTION>;","  });","  self.postMessage({event:'initDone'});","}]);","angular.bootstrap(null, ['WorkerApp']);"].join("\n");s.setAngularUrl=function(e){return u=e,s},s.addDependency=function(e,t,n){return c[e]={url:n,moduleName:t},s},s.createAngularWorker=function(t){if(!Array.isArray(t)||t.length<3||"function"!=typeof t[t.length-1])throw"Input needs to be: ['input','output'/*optional additional dependencies*/,\n    function(workerInput, deferredOutput /*optional additional dependencies*/)\n        {/*worker body*/}]";if("string"!=typeof u)throw"The url to angular must be defined before worker creation";var n=e.defer(),s=r(o(t)),c=(window.URL?URL:webkitURL).createObjectURL(new Blob([a(i(t[t.length-1],s.workerFuncParamList),s)],{type:"application/javascript"})),l=new Worker(c);return l.addEventListener("message",function(e){var t=e.data.event;"initDone"===t?n.resolve(p(l)):n.reject(e)}),n.promise};var p=function(t){var n={};return n.worker=t,n.run=function(n){var r=e.defer();return t.addEventListener("message",function(e){var t=e.data.event;if("initDone"===t)throw"Received worker initialization in run method. This should already have occurred!";"success"===t?r.resolve(e.data.data):"failure"===t?r.reject(e.data.data):"update"===t?r.notify(e.data.data):r.reject(e)}),t.postMessage(n),r.promise},n.terminate=function(){t.terminate()},n};return s}]);